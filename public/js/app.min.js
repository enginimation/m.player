var ui={},AppController={init:function(){var a=$(window).height()-105,b=$("#playing_songs");$(".scrollable_panel").height(a);$(window).bind("hashchange",function(){console.log("Hashchange fired!");AppController.handleAuthentication()});AppController.handleAuthentication();b.height("initial");b.css("max-height",a-184);this.appView=new ui.AppView;this.playerCtrl=new ui.PlayerCtrl;this.visualizationView=new ui.VisualizationView;this.visualizationView.el.height(a);Porridge.init({dbName:"mdb",dbDescription:"m.player database",
dbVersion:"1",stores:[Song.definition,Artist.definition,PlayList.definition]},function(){console.log("Inited views and social services/");AppController.playlistView=new ui.PlayListView;AppController.libraryMenu=new ui.LibraryMenu;AppController.soundcloudConnect();AppController.facebookConnect();AppController.lastfmConnect();AppController.detailsView=new ui.DetailsView})},handleAuthentication:function(){var a=_.firstHashValue();a&&(console.log("Auth token:",a),_.secondHashKey()==="scope"?dataService.getScUser(a,
function(b){if(b=b.full_name||b.username)AppController.settings.saveScAccessToken(a),AppController.settings.saveScUser(b),AppController.playerCtrl.scLogin(b),AppController.libraryMenu.showSoundCloudMenu(),AppController.libraryMenu.soundCloudTracks.url=AppController.libraryMenu.soundCloudTracks.url+"?access_token="+a,AppController.libraryMenu.soundCloudTracks.fetch()}):dataService.getFbUser(a,function(b){b.name&&(AppController.settings.saveFbAccessToken(a),AppController.settings.saveFbUser(b.name),
AppController.playerCtrl.fbLogin(b.name))}))},facebookConnect:function(){AppController.settings.isFbLogined()&&AppController.playerCtrl.fbLogin(AppController.settings.getFbUser())},soundcloudConnect:function(){if(AppController.settings.isScLogined())AppController.playerCtrl.scLogin(AppController.settings.getScUser()),AppController.libraryMenu.showSoundCloudMenu(),AppController.libraryMenu.soundCloudTracks.url=AppController.libraryMenu.soundCloudTracks.url+"?access_token="+AppController.settings.getScAccessToken(),
AppController.libraryMenu.soundCloudTracks.fetch()},lastfmConnect:function(){AppController.settings.isLastFmLogined()?AppController.playerCtrl.lastFmLogin():dataService.getSession(function(a){console.log("Last.fm session data",a);AppController.settings.saveLastFmUser(a.user);AppController.settings.saveLastFmSessionKey(a.key);AppController.settings.isLastFmLogined()?AppController.playerCtrl.lastFmLogin():AppController.playerCtrl.lastFmExit()})},settings:{saveShuffle:function(a){localStorage.setItem("isShuffle",
a)},isShuffle:function(){var a=localStorage.getItem("isShuffle");return a?JSON.parse(a):!1},saveRepeat:function(a){localStorage.setItem("isRepeat",a)},isRepeat:function(){var a=localStorage.getItem("isRepeat");return a?JSON.parse(a):!1},saveLastSong:function(a){localStorage.setItem("lastSong",JSON.stringify(a))},getLastSong:function(){return JSON.parse(localStorage.getItem("lastSong"))},saveVolume:function(a){localStorage.setItem("playerVolume",a)},getVolume:function(){return localStorage.getItem("playerVolume")||
0.5},savePlayList:function(a){localStorage.setItem("playlist",JSON.stringify(a))},getPlayList:function(){var a=JSON.parse(localStorage.getItem("playlist"));return new SongsList(a)},saveLastArtist:function(a){localStorage.setItem("lastArtist",a)},getLastArtist:function(){return localStorage.getItem("lastArtist")},saveLastAlbum:function(a){localStorage.setItem("lastAlbum",a)},getLastAlbum:function(){return localStorage.getItem("lastAlbum")},saveLastFmUser:function(a){localStorage.setItem("user",a)},
getLastFmUser:function(){return localStorage.getItem("user")||""},saveLastFmSessionKey:function(a){localStorage.setItem("sessionKey",a)},getLastFmSessionKey:function(){return localStorage.getItem("sessionKey")||""},isLastFmLogined:function(){return this.getLastFmUser()!==""&&this.getLastFmSessionKey()!==""},saveFbAccessToken:function(a){localStorage.setItem("fb_access_token",a)},getFbAccessToken:function(){return localStorage.getItem("fb_access_token")||""},saveFbUser:function(a){localStorage.setItem("fb_user_name",
a)},getFbUser:function(){return localStorage.getItem("fb_user_name")||""},isFbLogined:function(){return this.getFbUser()!==""&&this.getFbAccessToken()!==""},saveScAccessToken:function(a){localStorage.setItem("sc_access_token",a)},getScAccessToken:function(){return localStorage.getItem("sc_access_token")||""},saveScUser:function(a){localStorage.setItem("sc_user_name",a)},getScUser:function(){return localStorage.getItem("sc_user_name")||""},isScLogined:function(){return this.getScUser()!==""&&this.getScAccessToken()!==
""}},metadataParser:{parse:function(a,b,c){var d=(new Date).getTime();ID3.loadTags(a,function(){var b=(new Date).getTime();console.log("Time: "+(b-d)/1E3+"s");b=ID3.getAllTags(a);c(b)},{tags:["artist","title","album","year","comment","track","genre","lyrics"],dataReader:new FileAPIReader(b)})}}};_.mixin({contains:function(a,b){return a.toUpperCase().indexOf(b.toUpperCase())!==-1},firstHashValue:function(){return window.location.hash.substring(1).split("&")[0].split("=")[1]},secondHashKey:function(){return window.location.hash.substring(1).split("&")[1].split("=")[0]}});
var DataTransfer={create:function(a,b){return Object.create(this,{type:{value:a},value:{value:b}})},toString:function(){return JSON.stringify({type:this.type,value:this.value})},fromString:function(a){return JSON.parse(a)}},Song=Porridge.Model.extend({defaults:{album:"No information",title:"No information",artist:"No information",year:"",genre:""},remove:function(){this.destroy();fs.util.remove(this.get("fileName"))}},{definition:{name:"song",key:"id",indexes:[{name:"artists",field:"artist"}]}}),
SongsList=Porridge.Collection.extend({model:Song,comparator:function(a){var b=a.get("track");if(b&&b!=="")return parseInt(b,10);return a.get("name")},buildAlbumModel:function(a,b){return new Album({name:a,artist:b,songs:this.forAlbum(a)})},forAlbum:function(a){return this.filter(function(b){return b.get("album")===a})},listOfAlbums:function(){return _.uniq(this.pluck("album"))||[]},listOfGenres:function(){return _.uniq(this.pluck("genre"))||[]},lisOfAlbumsModels:function(){var a=new AlbumList;if(this.length>
0){var b=this.first().get("artist"),c=this.listOfAlbums(),d=this;_.each(c,function(c){var e=d.forAlbum(c);a.add(new Album({name:c,artist:b,songs:new SongsList(e)}))})}return a},remove:function(){this.each(function(a){a.remove()})}}),Artist=Porridge.Model.extend({defaults:{isDeleted:!1},initialize:function(){_.bindAll(this,"setParameterFromSongs","refresh","remove");if(!this.get("id"))this.id=UUID.generate(),this.set({id:this.id});this.songs=new SongsList;this.albumsModels=new AlbumList;this.songs.bind("retrieved",
this.setParameterFromSongs);this.refresh()},refresh:function(){this.songs.fetchByKey("artists",this.get("name"))},setParameterFromSongs:function(){var a=this.songs.listOfAlbums(),b=this.songs.listOfGenres(),c=this.songs.length;this.set({albums:a,genres:b,songsCount:c});c===0&&this.set({isDeleted:!0});this.albumsModels.refresh(this.songs.lisOfAlbumsModels().models)},remove:function(){this.set({isDeleted:!0});this.songs.remove();this.model.save()}},{definition:{name:"artist",key:"name"}}),ArtistsList=
Porridge.Collection.extend({model:Artist,forName:function(a){return this.find(function(b){return b.get("name")===a})},comparator:function(a){return a.get("name")}}),Album=Backbone.Model.extend({findImage:function(a){dataService.getAlbumImage(this.get("artist"),this.get("name"),a)}}),AlbumList=Backbone.Collection.extend({model:Album,isExist:function(a){return this.forModel(a)!==void 0},forModel:function(a){return this.find(function(b){return b.get("name")===a.get("name")})},forName:function(a){return this.find(function(b){return b.get("name")===
a})},comparator:function(a){return a.get("name")}}),PlayList=Porridge.Model.extend({defaults:{songs:[]},findSongs:function(){var a=this.get("songs")||[];return new SongsList(a)},findImage:function(a){var b=this.findSongs();b.length>0?(b=b.first(),dataService.getAlbumImage(b.get("artist"),b.get("album"),a)):a("css/images/no_picture.png")},findGenres:function(){return this.findSongs().listOfGenres()}},{definition:{name:"playlist",key:"id"}}),PlayLists=Porridge.Collection.extend({model:PlayList,forName:function(a){return this.find(function(b){return b.get("name")===
a})},comparator:function(a){return a.get("name")}}),SoundCloudTrack=Backbone.Model.extend({}),SoundCloudTrackList=Backbone.Collection.extend({model:SoundCloudTrack,url:"/sc/tracks"});
$(function(){ui.AppView=Backbone.View.extend({el:$("body"),progress:$("#uploading_files_progress progress"),helpScreen:$("#help_screen"),mainScreen:$("#main_screen"),isRegularMode:!0,dropFolderCtrl:$("#drop_folder"),dropFilesCtrl:$("#drop_files"),fileUploadStatusDialog:$("#file_upload_status_dialog"),events:{keyup:"keyPressed",dragover:"dragOverFiles","drop .main_panel":"dropFiles","change #drop_files":"dropFiles","change #drop_folder":"dropFiles","click #import_songs_directory":"importMusicDirectory",
"click #import_songs_files":"importMusicFiles"},initialize:function(){_.bindAll(this,"dragOverFiles","dropFiles","handleFileSelect","showHelp","hideHelp","showFullScreen","hideFullScreen","keyPressed","importMusicDirectory","importMusicFiles","processOneAudioFile")},importMusicDirectory:function(){this.dropFolderCtrl.click()},importMusicFiles:function(){this.dropFilesCtrl.click()},dragOverFiles:function(a){a.stopPropagation();a.preventDefault()},dropFiles:function(a){a.stopPropagation();a.preventDefault();
(a=(a.originalEvent.dataTransfer||a.originalEvent.target).files)&&a.length>0&&this.handleFileSelect(a)},handleFileSelect:function(a){var b=this,c=[];this.fileUploadStatusDialog.addClass("active");_.each(a,function(d,f){var e=async.apply(b.processOneAudioFile,d,f,a.length);c.push(e)});async.series(c,function(){b.fileUploadStatusDialog.removeClass("active")})},processOneAudioFile:function(a,b,c,d){var f=Math.floor((b+1)/c*100),e=this.$(this.progress);this.$("#file_index").html(b);this.$("#total_files_amount").html(c);
this.$("#uploading_files_progress header span").html(a.name);fs.read.fileAsBinaryString(a,function(a,b,c){a||AppController.metadataParser.parse(c.name,b,function(a){console.log("Tags",a);var b=new Song;if(a.track&&_.isString(a.track)){var g=a.track.indexOf("/");if(g>0)a.track=a.track.substring(0,g);if("0"===a.track.charAt(0))a.track=a.track.substring(1)}a.fileName=b.id+c.extension();a.originalFileName=c.name;b.set(a);fs.write.file(c,function(a){if(!a){b.save();AppController.playlistView.songs.add(b);
e.val(f);var a=b.get("artist"),c=AppController.libraryMenu.artists.forName(a);c?(c.set({isDeleted:!1}),a=c.get("songsCount")||0,c.set({songsCount:a+1}),c.songs.add(b,{silent:!0}),c.save(),c.change(),d(null)):(c=new Artist({name:a}),dataService.getArtistImage(c.get("name"),function(a){c.set({image:a});c.save();AppController.libraryMenu.artists.add(c);d(null)}))}},b.get("fileName"))})})},showHelp:function(){this.isRegularMode=!1;this.el.removeClass("fullscreen");this.helpScreen.removeClass("hidden");
this.mainScreen.addClass("hidden");AppController.visualizationView.hide()},hideHelp:function(){this.isRegularMode=!0;this.mainScreen.removeClass("hidden");this.helpScreen.addClass("hidden")},showFullScreen:function(){this.hideHelp();this.mainScreen.addClass("hidden");this.el.addClass("fullscreen");AppController.visualizationView.show()},hideFullScreen:function(){this.el.removeClass("fullscreen");this.isRegularMode?this.mainScreen.removeClass("hidden"):this.helpScreen.removeClass("hidden");AppController.visualizationView.hide()},
keyPressed:function(a){var a=a.keyCode,b;AppController.playlistView&&(b=AppController.playlistView.currentSong());a===40?AppController.playlistView.next(!1):a===38?AppController.playlistView.previous(!1):a===13?(AppController.playlistView.destroyFileURL(),b&&b.view.playSong()):a===32?AppController.playerCtrl.togglePause():a===46?b&&b.view.remove():a===27&&(AppController.playerCtrl.turnOffFullScreen(),AppController.playerCtrl.turnOffHelpMode())}});ui.VisualizationView=Backbone.View.extend({el:$("#playing_visualization"),
tpl:$("#visualization_tpl").html(),initialize:function(){_.bindAll(this,"selectSong","render","show","hide","renderAlbumPoster")},selectSong:function(a){this.model=a},show:function(){this.el.show();this.render()},hide:function(){this.el.hide()},renderAlbumPoster:function(a){a=_.template(this.tpl,{image:a});$(this.el).html(a)},render:function(){this.model&&dataService.getAlbumPoster(this.model.get("artist"),this.model.get("album"),this.renderAlbumPoster);return this}})});
$(function(){ui.LibraryMenu=Backbone.View.extend({el:$("#library_menu"),searchField:$("#library_menu header input"),artistsContent:$("#artists_library_content"),albumsContent:$("#albums_library_content"),playListsContent:$("#playlists_library_content"),soundCloudContent:$("#soundcloud_library_content"),events:{"click #show_artists":"showArtists","click #show_playlists":"showPlayLists","click #show_albums":"showAlbums","click #show_soundcloud":"showSoundCloud","blur input":"filterLibrary","keyup input":"keyPressed"},
initialize:function(){this.artists=new ArtistsList;this.playLists=new PlayLists;this.albums=new AlbumList;this.soundCloudTracks=new SoundCloudTrackList;this.tabName="artists";_.bindAll(this,"addArtist","addPlayList","addPlayLists","addAlbum","addSoundCloudTrack","addSoundCloudTracks","showArtists","showPlayLists","showAlbums","showSoundCloud","allArtistsLoaded","filterLibrary","keyPressed","showSoundCloudMenu");this.artists.bind("add",this.addArtist);this.artists.bind("retrieved",this.allArtistsLoaded);
this.playLists.bind("add",this.addPlayList);this.playLists.bind("refresh",this.addPlayLists);this.soundCloudTracks.bind("add",this.addSoundCloudTrack);this.soundCloudTracks.bind("refresh",this.addSoundCloudTracks);this.artists.fetch();this.playLists.fetch()},showSoundCloudMenu:function(){this.$("#show_soundcloud").removeClass("hidden")},keyPressed:function(a){a.keyCode===13&&this.filterLibrary()},allArtistsLoaded:function(){var a=AppController.settings.getLastArtist();a&&(a=this.artists.forName(a))&&
a.view&&a.view.selectArtist()},showArtists:function(){this.tabName="artists";this.$(this.searchField).attr("placeholder","Search artist");this.artistsContent.show();this.albumsContent.hide();this.playListsContent.hide();this.soundCloudContent.hide()},showAlbums:function(){this.tabName="albums";this.$(this.searchField).attr("placeholder","Search album");this.albumsContent.show();this.artistsContent.hide();this.playListsContent.hide();this.soundCloudContent.hide()},showPlayLists:function(){this.tabName=
"playlists";this.$(this.searchField).attr("placeholder","Search play list");this.playListsContent.show();this.artistsContent.hide();this.albumsContent.hide();this.soundCloudContent.hide()},showSoundCloud:function(){this.tabName="soundcloud";this.$(this.searchField).attr("placeholder","Search tracks");this.soundCloudContent.show();this.playListsContent.hide();this.artistsContent.hide();this.albumsContent.hide()},addAlbum:function(a){if(this.albums.isExist(a)){var b=this.albums.forModel(a);b.get("songs").add(a.get("songs").models);
b.trigger("add")}else this.albums.add(a),this.albumsContent.append((new ui.AlbumMenuView({model:a})).render().el)},addAlbums:function(a){a.each(this.addAlbum)},addArtist:function(a){var b=this;a.get("name")&&!a.get("isDeleted")&&(a.albumsModels.bind("refresh",function(){b.addAlbums(this)}),this.artistsContent.append((new ui.ArtistMenuView({model:a})).render().el))},addPlayList:function(a){this.playListsContent.append((new ui.PlayListMenuView({model:a})).render().el)},addSoundCloudTrack:function(a){this.soundCloudContent.append((new ui.SoundCloudTrackMenuView({model:a})).render().el)},
addSoundCloudTracks:function(){this.soundCloudTracks.each(this.addSoundCloudTrack)},addPlayLists:function(){this.playLists.each(this.addPlayList)},filterLibrary:function(){var a=this.searchField.val(),b=this.artists;if(this.tabName==="soundcloud")b=this.soundCloudTracks;else if(this.tabName==="playlists")b=this.playLists;else if(this.tabName==="albums")b=this.albums;!a||a===""?b.each(function(a){a.view&&a.view.show()}):b.each(function(b){_.contains(b.get("name"),a)?b.view&&b.view.show():b.view&&b.view.hide()})}});
ui.ArtistMenuView=Backbone.View.extend({className:"lib-item-data box",tagName:"article",tpl:$("#artist_tpl").html(),events:{click:"selectArtist",dblclick:"playArtistSongs","click .delete_artist":"deleteArtist","click .bio_artist":"showArtistBio","click .album_link":"selectAlbum","dblclick .album_link":"playAlbumSongs",dragstart:"handleDragStart"},initialize:function(){_.bindAll(this,"render","selectArtist","playArtistSongs","hide","show","deleteArtist","selectAlbum","playAlbumSongs","showArtistBio",
"handleDragStart");this.model.songs.bind("all",this.render);this.model.bind("change",this.render);this.model.view=this},render:function(){var a=_.template(this.tpl,{image:this.model.get("image"),name:this.model.get("name"),albums:this.model.get("albums"),genres:this.model.get("genres"),songsCount:this.model.get("songsCount")});this.el.draggable=!0;this.el.dataset.artist=this.model.get("name");$(this.el).html(a);return this},handleDragStart:function(a){var b=a.originalEvent,a=b.dataTransfer,b=DataTransfer.create("artist",
b.srcElement.dataset.artist);a.effectAllowed="move";a.setData("text/plain",b.toString())},selectArtist:function(){$(".lib-item-data").removeClass("selected-lib-item");$(this.el).addClass("selected-lib-item");AppController.detailsView.showAlbums(this.model.albumsModels,this.model.songs)},playArtistSongs:function(){this.selectArtist();AppController.playlistView.setSongsAndPlay(this.model.songs)},playAlbumSongs:function(a){a=this.model.songs.forAlbum(a.currentTarget.dataset.album);AppController.detailsView.songs.refresh(a);
AppController.playlistView.setSongsAndPlay(a)},deleteArtist:function(){this.model.set({isDeleted:!0});this.model.save();this.$(this.el).remove()},selectAlbum:function(a){a=this.model.songs.buildAlbumModel(a.currentTarget.dataset.album,this.model.get("name"));AppController.detailsView.showAlbum(a)},showArtistBio:function(){AppController.detailsView.showBio(this.model)},hide:function(){this.$(this.el).hide()},show:function(){this.$(this.el).show()}});ui.AlbumMenuView=Backbone.View.extend({className:"lib-item-data box",
tagName:"article",tpl:$("#album_lib_tpl").html(),events:{click:"selectAlbum",dblclick:"playAlbumSongs",dragstart:"handleDragStart"},initialize:function(){_.bindAll(this,"render","renderAlbumInfo","selectAlbum","playAlbumSongs","handleDragStart","hide","show");this.model.bind("change",this.render);this.model.bind("add",this.render);this.model.view=this},render:function(){this.model.findImage(this.renderAlbumInfo);this.el.draggable=!0;this.el.dataset.album=this.model.get("name");return this},renderAlbumInfo:function(a){a=
_.template(this.tpl,{image:a,name:this.model.get("name"),artist:this.model.get("artist"),songsCount:this.model.get("songs").length});$(this.el).html(a)},handleDragStart:function(a){var b=a.originalEvent,a=b.dataTransfer,b=DataTransfer.create("album",b.srcElement.dataset.album);a.effectAllowed="move";a.setData("text/plain",b.toString())},playAlbumSongs:function(){this.selectAlbum();AppController.playlistView.setSongsAndPlay(this.model.get("songs"))},selectAlbum:function(){$(".lib-item-data").removeClass("selected-lib-item");
$(this.el).addClass("selected-lib-item");this.model.get("songs");AppController.detailsView.showAlbum(this.model)},hide:function(){this.$(this.el).hide()},show:function(){this.$(this.el).show()}});ui.PlayListMenuView=Backbone.View.extend({className:"lib-item-data box",tagName:"article",tpl:$("#saved_playlist_tpl").html(),events:{click:"selectPlayList",dblclick:"playPlayList","click .delete_playlist":"deletePlaylist",dragstart:"handleDragStart"},initialize:function(){_.bindAll(this,"render","renderPlayListInfo",
"selectPlayList","playPlayList","deletePlaylist","handleDragStart","hide","show");this.model.bind("change",this.render);this.model.view=this},render:function(){this.model.findImage(this.renderPlayListInfo);this.el.draggable=!0;this.el.dataset.playlist=this.model.get("name");return this},renderPlayListInfo:function(a){a=_.template(this.tpl,{image:a,name:this.model.get("name"),genres:this.model.findGenres(),songsCount:this.model.get("songs").length});$(this.el).html(a)},handleDragStart:function(a){var b=
a.originalEvent,a=b.dataTransfer,b=DataTransfer.create("playlist",b.srcElement.dataset.playlist);a.effectAllowed="move";a.setData("text/plain",b.toString())},selectPlayList:function(){$(".lib-item-data").removeClass("selected-lib-item");$(this.el).addClass("selected-lib-item");AppController.detailsView.showPlayList(this.model)},playPlayList:function(){this.selectPlayList();AppController.playlistView.setSongsAndPlay(this.model.findSongs())},deletePlaylist:function(){this.model.destroy();this.$(this.el).remove()},
hide:function(){this.$(this.el).hide()},show:function(){this.$(this.el).show()}});ui.SoundCloudTrackMenuView=Backbone.View.extend({className:"lib-item-data box",tagName:"article",tpl:$("#sound_cloud_track_menu_tpl").html(),initialize:function(){_.bindAll(this,"render","hide","show");this.model.view=this},render:function(){var a=_.template(this.tpl,{name:this.model.get("name")});$(this.el).html(a);return this},hide:function(){this.$(this.el).hide()},show:function(){this.$(this.el).show()}})});
$(function(){ui.PlayListView=Backbone.View.extend({el:$("#playing_list"),infoEl:$("#playing_list #song_info_view"),songsEl:$("#playing_list #playing_songs"),dropFileLabel:$("#playing_list #playing_songs label"),statEL:$("#playing_list footer"),songInfoTpl:$("#song_info_tpl").html(),playlistStatTpl:$("#playlist_stat_tpl").html(),newPlayListName:$("#new_play_list"),events:{drop:"handleDrop","blur #new_play_list":"savePlayList","click #clear_playlist":"clearPlaylist"},initialize:function(){this.songs=
new SongsList;_.bindAll(this,"addOne","addAll","saveFileURL","destroyFileURL","currentSong","currentSongIndex","randomSong","renderAlbumInfo","render","clearPlaylist","playSongModel","savePlayList","setPlayListModel","removePlayListModel","setSongsAndPlay");this.bind("song:select",this.selectSong);this.bind("url:create",this.saveFileURL);this.songs.bind("add",this.addOne);this.songs.bind("refresh",this.addAll);this.songs.bind("all",this.render);var a=AppController.settings.getPlayList();a&&(this.songs.refresh(a.models),
(a=AppController.settings.getLastSong())&&this.selectSong(new Song(a)))},render:function(){this.statEL.html(_.template(this.playlistStatTpl,{songsCount:this.songs.length}));return this},setSongsAndPlay:function(a){this.songs.refresh(a.models);var b=this.songs.first();b&&(b.view.playSong(),AppController.settings.saveLastAlbum(b.get("album")),AppController.settings.saveLastArtist(b.get("artist")));AppController.settings.savePlayList(a)},setPlayListModel:function(a){this.playList=a;this.newPlayListName.val(this.playList.get("name"))},
removePlayListModel:function(){this.playList=null;this.newPlayListName.val("Unsaved list")},savePlayList:function(){var a=this.newPlayListName.val();if(a!=="Unsaved list"){if(!this.playList)this.playList=new PlayList;var b=this.songs.toJSON();this.playList.set({name:a,songs:b});this.playList.save();AppController.libraryMenu.playLists.add(this.playList)}},clearPlaylist:function(){this.songsEl.empty();this.songs.refresh([]);AppController.settings.savePlayList(this.songs);this.render()},addOne:function(a){if(a.get("fileName")){this.dropFileLabel.remove();
var b=new ui.SongMiniView({model:a,playlist:this});a.view=b;this.songsEl.append(b.render().el)}},addAll:function(){this.songs.length!==0&&(this.songsEl.empty(),this.songs.each(this.addOne))},handleDrop:function(a){a.stopPropagation();a.preventDefault();var b=a.originalEvent.dataTransfer;if(b&&b.getData("text/plain")){if(a=DataTransfer.fromString(b.getData("text/plain")))if("artist"===a.type){if(a=AppController.libraryMenu.artists.forName(a.value)){var c=this.songs;a.songs.each(function(a){c.add(a)})}}else if("album"===
a.type){if(a=AppController.libraryMenu.albums.forName(a.value))c=this.songs,a.get("songs").each(function(a){c.add(a)})}else if("playlist"===a.type){if(a=AppController.libraryMenu.playLists.forName(a.value))c=this.songs,a.findSongs().each(function(a){c.add(a)})}else"song"===a.type&&this.songs.add(new Song(a.value))}else AppController.appView.dropFiles(a)},selectSong:function(a){this.selectedSong=a;dataService.getAlbumImage(this.selectedSong.get("artist"),this.selectedSong.get("album"),this.renderAlbumInfo)},
renderAlbumInfo:function(a){this.infoEl.html(_.template(this.songInfoTpl,{image:a,name:this.selectedSong.get("title"),artist:this.selectedSong.get("artist"),album:this.selectedSong.get("album"),year:this.selectedSong.get("year")}))},saveFileURL:function(a){this.fileURL=a},destroyFileURL:function(){this.fileURL&&fs.util.destroyFileURL(this.fileURL)},randomSong:function(){var a=Math.floor(Math.random()*this.songs.length);if(a===this.currentSong())return this.randomSong();return a},currentSong:function(){return this.songs.at(this.currentSongIndex())},
currentSongIndex:function(){return this.songs.indexOf(this.selectedSong)},next:function(a){var a=!a,b=-1;a&&AppController.settings.isShuffle()?b=this.randomSong():(b=this.currentSongIndex(),b===this.songs.length-1&&(b=-1,AppController.settings.isRepeat()||(a=!1)),b+=1);this.playSongModel(this.songs.at(b),a)},previous:function(a){var a=!a,b=this.currentSongIndex();if(b===0)b=this.songs.length;this.playSongModel(this.songs.at(b-1),a)},playSongModel:function(a,b){b?(this.destroyFileURL(),a&&a.view&&
a.view.playSong()):!b&&a&&a.view&&a.view.selectSong()}});ui.SongMiniView=Backbone.View.extend({className:"song-data",tpl:$("#song_mini_tpl").html(),events:{"click .song":"selectSong","dblclick .song":"playSong"},initialize:function(){_.bindAll(this,"render","selectSong","playSong","songFileLoaded")},render:function(){this.el.draggable=!0;this.el.dataset.songname=this.model.get("title");this.el.dataset.id=this.model.id;this.el.id=this.model.id;var a=_.template(this.tpl,{track:this.model.get("track"),
title:this.model.get("title"),album:this.model.get("album"),year:this.model.get("year")});$(this.el).html(a);return this},selectSong:function(){$(".song-data").removeClass("selected_song");$(this.el).addClass("selected_song");this.options.playlist.trigger("song:select",this.model);AppController.visualizationView.selectSong(this.model)},playSong:function(){AppController.settings.saveLastSong(this.model.toJSON());this.selectSong();fs.util.createFileURL(this.model.get("fileName"),this.songFileLoaded)},
songFileLoaded:function(a,b){a||(this.options.playlist.trigger("url:create",b),AppController.playerCtrl.play(b))}})});
$(function(){ui.DetailsView=Backbone.View.extend({el:$("#filtered_lib"),libDetailsPanel:$("#filtered_lib_content"),artistBioPanel:$("#artist_bio"),events:{dragstart:"handleDragStart"},initialize:function(){_.bindAll(this,"showAlbums","showAlbum","showPlayList","handleDragStart","showBio","hideBio");this.artistBioView=new ui.ArtistBioView},showBio:function(a){this.artistBioPanel.show();this.artistBioView.setArtistModel(a);this.artistBioView.render();this.libDetailsPanel.hide()},hideBio:function(){this.artistBioPanel.hide();
this.artistBioView.clear();this.libDetailsPanel.show();this.libDetailsPanel.empty()},showAlbums:function(a,b){this.hideBio();a&&a.each(this.showAlbum);this.songs=b},showAlbum:function(a){this.hideBio();this.songs=a.get("songs");this.libDetailsPanel.append((new ui.AlbumView({model:a})).render().el)},showPlayList:function(a){this.hideBio();this.libDetailsPanel.append((new ui.PlayListFullView({model:a})).render().el)},handleDragStart:function(a){var b=a.originalEvent,a=b.dataTransfer,b=b.srcElement.dataset.id;
a.effectAllowed="move";this.songs&&(b=this.songs.get(b),b=DataTransfer.create("song",b),a.setData("text/plain",b.toString()))}});ui.ArtistBioView=Backbone.View.extend({el:$("#artist_bio"),tpl:$("#artist_bio_tpl").html(),initialize:function(){_.bindAll(this,"render","setArtistModel","renderArtistBio","clear")},setArtistModel:function(a){this.model=a},render:function(){this.model&&dataService.getArtistBio(this.model.get("name"),this.renderArtistBio);return this},renderArtistBio:function(a){a=_.template(this.tpl,
{bio:unescape(a.summary),profiles:a.profile||{}});$(this.el).html(a)},clear:function(){$(this.el).html("")}});ui.AlbumView=Backbone.View.extend({className:"lib_item_full_info_panel",tagName:"article",initialize:function(){_.bindAll(this,"addSong","render")},render:function(){this.albumInfoView=new ui.AlbumInfoView({model:this.model});$(this.el).append(this.albumInfoView.render().el);this.model.get("songs").each(this.addSong);return this},addSong:function(a,b){var c=new ui.SongView({model:a,key:b,
songs:this.model.get("songs")});a.albumView=c;$(this.el).append(c.render().el)}});ui.PlayListFullView=Backbone.View.extend({className:"lib_item_full_info_panel",tagName:"article",tpl:$("#detailed_playlist_info_tpl").html(),events:{click:"playSongs"},initialize:function(){_.bindAll(this,"addSong","render","renderPlayListInfo","playSongs")},render:function(){this.model.findImage(this.renderPlayListInfo);return this},renderPlayListInfo:function(a){a=_.template(this.tpl,{image:a,name:this.model.get("name")});
$(this.el).append(a);_.each(this.model.get("songs"),this.addSong)},addSong:function(a,b){var c=new Song(a),d=new ui.SongView({model:c,key:b,songs:this.model.get("songs"),playList:this.model});c.albumView=d;$(this.el).append(d.render().el)},playSongs:function(){AppController.playlistView.setSongsAndPlay(this.model.get("songs"))}});ui.AlbumInfoView=Backbone.View.extend({className:"detailed_album_info_panel box",tagName:"section",tpl:$("#detailed_album_info_tpl").html(),events:{click:"playSongs"},initialize:function(){_.bindAll(this,
"renderAlbumInfo","render","playSongs")},renderAlbumInfo:function(a){a=_.template(this.tpl,{image:a.image,name:this.model.get("name"),releaseDate:a.releaseDate==="no information"?"":a.releaseDate});$(this.el).append(a)},render:function(){dataService.getAlbumInfo(this.model.get("artist"),this.model.get("name"),this.renderAlbumInfo);return this},playSongs:function(){AppController.playlistView.setSongsAndPlay(this.model.get("songs"))}});ui.SongView=Backbone.View.extend({className:"song-data",tpl:$("#song_tpl").html(),
events:{click:"selectSong","click .delete_album_song":"deleteSong","dblclick .song":"playSongs"},initialize:function(){_.bindAll(this,"selectSong","deleteSong","onDeleteSong","playSongs","render")},render:function(){this.el.draggable=!0;this.el.dataset.songname=this.model.get("title");this.el.dataset.id=this.model.id;this.el.id=this.model.id;var a=_.template(this.tpl,{track:this.model.get("track")||this.options.key+1,title:this.model.get("title")});$(this.el).html(a);return this},selectSong:function(){$(".song-data").removeClass("selected_song");
$(this.el).addClass("selected_song")},deleteSong:function(){this.model.bind("destroy",this.onDeleteSong);this.model.remove()},onDeleteSong:function(){var a=this.model.albumView;a&&a.remove()},playSongs:function(){var a=this.options.songs;this.selectSong();AppController.playlistView.setSongsAndPlay(a);this.options.playList?AppController.playlistView.setPlayListModel(this.options.playList):AppController.playlistView.removePlayListModel()}})});
$(function(){ui.PlayerCtrl=Backbone.View.extend({el:$("#player"),mainControls:$("#main_controls_panel"),socialControls:$("#social_controls_panel"),playToggle:$("#play_toggle"),soundToggle:$("#sound_toggle"),shuffleToggle:$("#shuffle_toggle"),repeatToggle:$("#repeat_toggle"),playerModeToggle:$("#expand"),helpModeToggle:$("#help"),socialModeToggle:$("#social"),loadedMusicSlider:!1,volumeSlider:$("#volume_slider"),musicSlider:$("#music_slider"),soundOffIcon:$("#sound_off_icon"),soundOnIcon:$("#sound_on_icon"),
timeCounterEl:$("#time_counter"),lastFmLoginBtn:$("#lastfm_login_btn"),lastFmUsername:$("#lastfm_username"),lastFmControlPanel:$("#lastfm_control_panel"),fbLoginBtn:$("#fb_login_btn"),fbLogoutBtn:$("#fb_logout_btn"),fbUsername:$("#fb_username"),fbControlPanel:$("#fb_control_panel"),scLoginBtn:$("#sc_login_btn"),scLogoutBtn:$("#sc_logout_btn"),scUsername:$("#sc_username"),scControlPanel:$("#sc_control_panel"),events:{"click #play_toggle.paused":"resume","click #play_toggle.playing":"pause","click #stop_song":"stop",
"click #previous_song":"previous","click #next_song":"next","click #sound_toggle.off":"soundOn","click #sound_toggle.on":"soundOff","click #shuffle_toggle.on":"shuffleOff","click #shuffle_toggle.off":"shuffleOn","click #repeat_toggle.on":"repeatOff","click #repeat_toggle.off":"repeatOn","click #expand.on":"turnOnFullScreen","click #expand.off":"turnOffFullScreen","click #help.on":"turnOffHelpMode","click #help.off":"turnOnHelpMode","click #social.on":"hideSocialPanel","click #social.off":"showSocialPanel",
"click #volume_slider":"changedVolume","click #music_slider":"changedMusicProgress","click #lastfm_logout_btn":"lastFmExit","click #fb_logout_btn":"fbLogout","click #sc_logout_btn":"scLogout"},initialize:function(){_.bindAll(this,"updateAudioProgress","songFinished","togglePause","changedVolume","turnOnFullScreen","turnOffFullScreen","turnOnHelpMode","turnOffHelpMode","changedMusicProgress","showSocialPanel","hideSocialPanel","lastFmLogin","lastFmExit","fbLogin","fbLogout","scLogin","scLogout");this.audioEl=
AudioEl.newAudio("player_ctrl");this.audioEl.bind("updated",this.updateAudioProgress);this.audioEl.bind("finished",this.songFinished);this.audioEl.volume=AppController.settings.getVolume();this.volumeSlider.attr("value",AppController.settings.getVolume())},scLogin:function(a){this.scLoginBtn.hide();this.scControlPanel.removeClass("unlogined");this.scControlPanel.addClass("logined");this.scUsername.html(a)},scLogout:function(){this.scLoginBtn.show();this.scControlPanel.removeClass("logined");this.scControlPanel.addClass("unlogined");
this.scUsername.html("");AppController.settings.saveScAccessToken("");AppController.settings.saveScUser("")},fbLogin:function(a){this.fbLoginBtn.hide();this.fbControlPanel.removeClass("unlogined");this.fbControlPanel.addClass("logined");this.fbUsername.html(a)},fbLogout:function(){this.fbLoginBtn.show();this.fbControlPanel.removeClass("logined");this.fbControlPanel.addClass("unlogined");this.fbUsername.html("");AppController.settings.saveFbAccessToken("");AppController.settings.saveFbUser("")},lastFmLogin:function(){this.lastFmLoginBtn.hide();
this.lastFmControlPanel.removeClass("unlogined");this.lastFmControlPanel.addClass("logined");this.lastFmUsername.html(AppController.settings.getLastFmUser())},lastFmExit:function(){AppController.settings.saveLastFmUser("");AppController.settings.saveLastFmSessionKey("");this.lastFmControlPanel.removeClass("logined");this.lastFmControlPanel.addClass("unlogined");this.lastFmLoginBtn.show();this.lastFmUsername.html("")},showSocialPanel:function(){this.$(this.el).addClass("socialized");this.socialModeToggle.removeClass("off");
this.socialModeToggle.addClass("on");this.$(this.mainControls).addClass("hidden");this.$(this.socialControls).removeClass("hidden")},hideSocialPanel:function(){this.$(this.el).removeClass("socialized");this.socialModeToggle.removeClass("on");this.socialModeToggle.addClass("off");this.$(this.socialControls).addClass("hidden");this.$(this.mainControls).removeClass("hidden")},turnOnHelpMode:function(){this.helpModeToggle.removeClass("off");this.helpModeToggle.addClass("on");AppController.appView.showHelp()},
turnOffHelpMode:function(){this.helpModeToggle.removeClass("on");this.helpModeToggle.addClass("off");AppController.appView.hideHelp()},turnOnFullScreen:function(){this.playerModeToggle.removeClass("on");this.playerModeToggle.addClass("off");this.playerModeToggle.attr("title","Library mode");AppController.appView.showFullScreen()},turnOffFullScreen:function(){this.playerModeToggle.removeClass("off");this.playerModeToggle.addClass("on");this.playerModeToggle.attr("title","Full screen mode");AppController.appView.hideFullScreen()},
changedMusicProgress:function(a){if(this.loadedMusicSlider){var a=a.offsetX,b=this.musicSlider.width(),c=parseFloat(this.musicSlider.attr("max")),d=a/b*c;console.log(a,b,c);this.musicSlider.attr("value",d);this.audioEl.time=d}},changedVolume:function(a){var a=a.offsetX,b=this.volumeSlider.width();a/=b;a>0.95&&(a=1);this.audioEl.volume=a;this.volumeSlider.attr("value",a);AppController.settings.saveVolume(a)},soundOn:function(){this.soundToggle.attr("title","Mute");this.soundToggle.addClass("on");this.soundToggle.removeClass("off");
this.soundOnIcon.show();this.soundOffIcon.hide();this.audioEl.volume=this.volume||0.5},soundOff:function(){this.soundToggle.attr("title","Sound");this.soundToggle.addClass("off");this.soundToggle.removeClass("on");this.soundOffIcon.show();this.soundOnIcon.hide();this.volume=this.audioEl.volume;this.audioEl.volume=0},shuffleOn:function(){this.shuffleToggle.attr("title","Turn shuffle off");this.shuffleToggle.addClass("on");this.shuffleToggle.removeClass("off");AppController.settings.saveShuffle(!0)},
shuffleOff:function(){this.shuffleToggle.attr("title","Turn shuffle on");this.shuffleToggle.addClass("off");this.shuffleToggle.removeClass("on");AppController.settings.saveShuffle(!1)},repeatOn:function(){this.repeatToggle.attr("title","Turn repeat off");this.repeatToggle.addClass("on");this.repeatToggle.removeClass("off");AppController.settings.saveRepeat(!0)},repeatOff:function(){this.repeatToggle.attr("title","Turn repeat on");this.repeatToggle.addClass("off");this.repeatToggle.removeClass("on");
AppController.settings.saveRepeat(!1)},play:function(a){this.loadedMusicSlider=!1;this.playToggle.attr("title","Pause");this.playToggle.addClass("playing");this.playToggle.removeClass("paused");this.audioEl.play(a)},resume:function(){this.play()},pause:function(){this.$(this.playToggle).attr("title","Play");this.$(this.playToggle).addClass("paused");this.$(this.playToggle).removeClass("playing");this.audioEl.pause()},togglePause:function(){this.$(this.playToggle).hasClass("paused")?this.play():this.pause()},
stop:function(){this.playToggle.addClass("paused");this.playToggle.removeClass("playing");this.audioEl.stop();this.loadedMusicSlider=!1},previous:function(){AppController.playlistView.previous()},next:function(){AppController.playlistView.next()},updateAudioProgress:function(a,b){this.$(this.timeCounterEl).text(this.audioEl.timeCounter);this.musicSlider.attr("value",b);if(!this.loadedMusicSlider)this.loadedMusicSlider=!0,this.musicSlider.attr("max",a)},songFinished:function(){var a=AppController.playlistView.currentSong(),
b=parseInt(this.audioEl.time,10);if(a)this.loadedMusicSlider=!1,dataService.scrobble(a.get("title"),a.get("artist"),b),this.next()}})});
